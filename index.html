<!DOCTYPE HTML>
<html>
  <head>
  <title>Math Wars!</title>
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro">
    <style>
      * { margin:0; padding:0; } /* to remove the top and left whitespace */

      html, body { width:100%; height:100%; overflow: hidden} /* just to be sure these are full screen*/

      canvas { display:block; }

      body {
          font-family: 'Source Sans Pro', 'Arial';
          font-size: 24px;
          background-color: #000000;
        }
      canvas { /* Just to get rid of selected text when click */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        outline: none;
        -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
      }
    </style>
  </head>

  <body>
    <div style="position: relative;">
   <canvas id="layer1" width="100" height="100"
     style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
   <canvas id="layer2" width="100" height="100"
     style="position: absolute; left: 0; top: 0; z-index: 1; opacity:1.0"></canvas>
  </div>

    <script>
      // Draw backgroud
      var canvas = document.getElementById('layer1');
      var ctx = canvas.getContext('2d');
      ctx.canvas.width  = window.innerWidth ;
      ctx.canvas.height = window.innerHeight;

      ctx.fillStyle="#EEEEEE";
      for(var i = 1; i <= 100; i++){
        ctx.fillRect(Math.random()*ctx.canvas.width, Math.random()*ctx.canvas.height,1, 1);
      }

      // Get main canvas
      canvas = document.getElementById('layer2');
      ctx = canvas.getContext('2d');
      ctx.canvas.width  = window.innerWidth;
      ctx.canvas.height = window.innerHeight;

      // Prevent browser to using backspace
      function preventBackspaceHandler(evt) {
          evt = evt || window.event;
          if (evt.keyCode == 8) {
              return false;
          }
      }
      document.onkeydown = preventBackspaceHandler;

      // Do things when key is pressed
      function doKeyDown(e) {
        e = e || window.event;

        //  backspace
        if ( e.keyCode == 8 ) {
          gameState.input = gameState.input.substring(0, gameState.input.length - 1);
        };
        // Handle numbers
        if ( e.keyCode <= 57 && e.keyCode >= 48) {
          gameState.input += e.keyCode - 48;
        }
        // Handle numpad numbers
        if ( e.keyCode <= 105 && e.keyCode >= 96) {
          gameState.input += e.keyCode - 96;
        }
        //handle enter
        if ( e.keyCode == 13 ) {
          // Reverse to get bigger asteroids first
          asteroids.reverse().forEach(function(asteroid) {
            if(asteroid.number == parseInt(gameState.input)){
                asteroid.hit();
            }
          });
          gameState.input = "";
        }
      }

      window.addEventListener( "keydown", doKeyDown, false);


      var imageAsteroid = new Image();

      // I have to figure out copyright of images. At least I'm showing the original sources. None are mine.
      imageAsteroid.src = 'asteroid.svg'

      var FPS = 30;
      setInterval(function() {
        update();
        draw();
      }, 1000/FPS);

      var scalingFactor = 1.025;
      var maximumSize = 600;
      var shakeFrames = 7;
      var toShake = shakeFrames + 1;

      var asteroids = [];

      var gameState = {
        damage: 0,
        score: 0,
        input: ""
      };

      function Asteroid(x, y, size) {
        this.image = imageAsteroid
        this.size = size;
        this.x = x;
        this.y = y;
        this.scalingFactor = scalingFactor + Math.random()*0;

        // Operation to perform
        this.text = Math.round(Math.random()*10) + " + " + Math.round(Math.random()*10);
        this.number = eval(this.text);

        this.draw = function() {
          ctx.drawImage(this.image, this.x, this.y, this.size, this.size);
          ctx.font = "bold " + this.size/8 + "px Arial";
          ctx.fillStyle = "DarkGreen";
          ctx.fillText(this.text, this.x + this.size/2.4, this.y + this.size/2);
        },

        this.update = function() {
          this.size *= this.scalingFactor;
          if(this.size > maximumSize){
            // Remove itself from asteroids list
            asteroids.splice(asteroids.indexOf(this), 1);

            // If size is big and is alive, we're hit!!
            if(this.image == imageAsteroid){
              gameState.damage += 1
              toShake = 0;
            }
          }
        },

        this.hit= function() {
          gameState.score += 1;
          asteroids.splice(asteroids.indexOf(this), 1);
        };
      }

      function compareAsteroidSizes(a, b) {
        if (a.size < b.size)
           return -1;
        if (a.size > b.size)
          return 1;
        return 0;
      }

      for(var i = 1; i <= 3; i++){
        asteroids.push(new Asteroid(200 + Math.random()*(ctx.canvas.width - 400), 200 + Math.random()*(ctx.canvas.height - 400), Math.random()*100));
      };

      function preShake() {
        ctx.save();
        var dx = Math.random()*20;
        var dy = Math.random()*20;
        ctx.translate(dx, dy);
      }

      function postShake() {
        ctx.restore();
      }

      function update() {
        // Increment shake frames counter
        toShake += 1

        asteroids.forEach(function(asteroid) {
          asteroid.update();
        });

        // Add more asteroids if needed
        if(asteroids.length < 3){
          asteroids.push(new Asteroid(200 + Math.random()*(ctx.canvas.width - 400), 200 + Math.random()*(ctx.canvas.height - 400), 10));
        };
      };

      function draw() {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        ctx.font = "bold 24px Arial";
        ctx.fillStyle = "purple";
        ctx.fillText("Damage: " + gameState.damage, 30, 30);
        ctx.fillStyle = "blue";
        ctx.fillText("Score: " + gameState.score, 30, 60);
        ctx.fillStyle = "green";
        ctx.fillText("Input: " + gameState.input, 30, 120);
        // Put greater asteroids in front
        asteroids.sort(compareAsteroidSizes);

        // Shake screen if recently hit
        if(toShake <= shakeFrames){
          preShake();
          asteroids.forEach(function(asteroid) {
            asteroid.draw();
          });
          postShake();
        } else {
          asteroids.forEach(function(asteroid) {
            asteroid.draw();
          });
        };
      }
    </script>
  </body>
</html>
